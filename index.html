<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:'Tajawal',sans-serif;
  display:flex;
  justify-content:center;
}
.chat{
  width:95%;
  max-width:450px;
  height:97vh;
  background:#000;
  border-left:1px solid #fff;
  border-right:1px solid #fff;
  display:flex;
  flex-direction:column;
}
header{
  text-align:center;
  padding:12px;
  border-bottom:1px solid #fff;
}
#chatBox{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.message{
  align-self:flex-end;
  border:1px solid #fff;
  border-radius:10px;
  padding:10px;
  max-width:75%;
  position:relative;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.msg-text{
  white-space:pre-wrap;
  word-break:break-word;
}
.status{
  font-size:11px;
  opacity:.6;
  text-align:right;
}
#inputArea{
  display:flex;
  padding:10px;
  gap:8px;
}
#msgInput{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #fff;
  background:#000;
  color:#fff;
}
.btn{
  width:55px;
  height:45px;
  border-radius:50%;
  border:1px solid #fff;
  background:#000;
  color:#fff;
}
.msg-toolbar{
  position:absolute;
  background:#fff;
  color:#000;
  padding:5px;
  border-radius:8px;
  display:flex;
  gap:6px;
  z-index:1000;
}
.msg-toolbar button{
  background:#fff;
  border:1px solid #000;
  border-radius:4px;
  padding:4px 6px;
}
audio{
  width:150px;
}
#recordingBox{
  display:none;
  background:#fff;
  color:#000;
  padding:12px;
  text-align:center;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="chat">

<header>Chat</header>

<div id="recordingBox">جاري التسجيل… <span id="timer">00:00</span></div>

<div id="chatBox"></div>

<div id="inputArea">
  <input type="text" id="msgInput" placeholder="اكتب...">
  <button class="btn" id="micBtn">Mic</button>
</div>

</div>

<script>
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const micBtn = document.getElementById("micBtn");
const recordingBox = document.getElementById("recordingBox");
const timerDisplay = document.getElementById("timer");

let recorder=null, chunks=[], seconds=0, timerInterval=null, isRecording=false;

/* إضافة رسالة */
function addMessage(content, type="text"){
  const msg = document.createElement("div");
  msg.className="message";

  let inner = document.createElement("span");
  inner.className="msg-text";

  if(type==="text"){
    inner.textContent = content;
    msg.appendChild(inner);
  }
  else if(type==="audio"){
    inner.innerHTML = `<audio controls src="${content}"></audio>`;
    msg.appendChild(inner);
  }

  let sts = document.createElement("div");
  sts.className="status";
  sts.textContent="Read";
  msg.appendChild(sts);

  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;

  attachToolbar(msg);
}

/* Toolbar: Copy/Edit/Delete */
function attachToolbar(msg){
  msg.addEventListener("click", ()=>{
    const old = document.querySelector(".msg-toolbar");
    if(old) old.remove();

    const toolbar = document.createElement("div");
    toolbar.className="msg-toolbar";

    const copyBtn = document.createElement("button");
    const editBtn = document.createElement("button");
    const delBtn  = document.createElement("button");

    copyBtn.textContent="Copy";
    editBtn.textContent="Edit";
    delBtn.textContent="Delete";

    toolbar.appendChild(copyBtn);
    toolbar.appendChild(editBtn);
    toolbar.appendChild(delBtn);

    document.body.appendChild(toolbar);

    let rect = msg.getBoundingClientRect();
    toolbar.style.top = (rect.top + window.scrollY - 40) + "px";
    toolbar.style.left = rect.left + "px";

    copyBtn.onclick = ()=>{
      let text = msg.querySelector(".msg-text").innerText;
      let ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toolbar.remove();
      alert("Copied!");
    };

    editBtn.onclick = ()=>{
      let span = msg.querySelector(".msg-text");
      let newText = prompt("Edit message:", span.innerText);
      if(newText!==null) span.innerText = newText;
      toolbar.remove();
    };

    delBtn.onclick = ()=>{
      msg.remove();
      toolbar.remove();
    };

    document.addEventListener("click", function hide(ev){
      if(!msg.contains(ev.target) && !toolbar.contains(ev.target)){
        toolbar.remove();
        document.removeEventListener("click", hide);
      }
    });

  });
}

/* تسجيل صوت */
function updateTimer(){
  seconds++;
  const m = String(Math.floor(seconds/60)).padStart(2,"0");
  const s = String(seconds%60).padStart(2,"0");
  timerDisplay.textContent = `${m}:${s}`;
}

async function startRecording(){
  if(isRecording) return;
  isRecording=true;
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  recorder = new MediaRecorder(stream);
  chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:"audio/mp3"});
    const url = URL.createObjectURL(blob);
    addMessage(url,"audio");
    recorder = null;
    recordingBox.style.display="none";
    clearInterval(timerInterval);
    seconds=0;
    timerDisplay.textContent="00:00";
    isRecording=false;
    stream.getTracks().forEach(t=>t.stop());
  };
  recorder.start();
  seconds=0;
  timerDisplay.textContent="00:00";
  recordingBox.style.display="block";
  timerInterval = setInterval(updateTimer,1000);
}

function stopRecording(){
  if(!isRecording) return;
  if(recorder && recorder.state==="recording") recorder.stop();
}

/* زر Mic ↔ Send */
msgInput.addEventListener("input", ()=>{
  micBtn.textContent = msgInput.value.trim().length ? "Send" : "Mic";
});

micBtn.addEventListener("click", ()=>{
  if(msgInput.value.trim().length){
    addMessage(msgInput.value,"text");
    msgInput.value="";
    micBtn.textContent="Mic";
  } else {
    if(!isRecording) startRecording();
    else stopRecording();
  }
});
</script>

</body>
</html>
