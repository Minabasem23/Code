<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>دردشة أبيض وأسود</title>
<style>
body {margin:0; background:#000; font-family:'Tajawal',sans-serif; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh;}
.chat-container {width:95%; max-width:450px; height:92vh; background:#000; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; position:relative;}
header.chat-header {text-align:center; padding:15px; font-weight:bold; border-bottom:1px solid #fff;}
.chat-messages {flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:14px;}
.message {background:#000; color:#fff; padding:10px 14px; max-width:75%; border-radius:12px; align-self:flex-end; word-wrap:break-word; border:1px solid #fff; display:flex; flex-direction:column; gap:6px; position:relative;}
.status {margin-top:4px; font-size:11px; opacity:.7; text-align:right;}
#recordingBox {display:none; background:#fff; color:#000; padding:12px; text-align:center; font-weight:bold; position:absolute; bottom:60px; left:0; width:100%; border-radius:8px;}
.chat-input {padding:10px; background:#000; display:flex; align-items:center; gap:8px; position:relative;}
.chat-input input {flex:1; background:#000; color:#fff; padding:12px; border:1px solid #fff; border-radius:10px;}
.btn {width:60px; height:45px; background:#000; border-radius:50%; border:1px solid #fff; font-size:20px; color:#fff;}
.attach-bar {position:absolute; bottom:-70px; left:0; width:100%; background:#000; border-top-left-radius:12px; border-top-right-radius:12px; padding:10px; display:flex; justify-content:space-around; transition:bottom 0.3s;}
.attach-bar.show {bottom:60px;}
.attach-bar button {background:#000; border:1px solid #fff; padding:12px; border-radius:10px; color:#fff; font-size:16px;}
.msg-toolbar {background:#fff; color:#000; border-radius:8px; padding:4px; display:flex; gap:6px; position:absolute; z-index:1000;}
.msg-toolbar button {background:#fff; border:1px solid #000; padding:4px 6px; border-radius:4px; cursor:pointer;}
</style>
</head>
<body>

<div class="chat-container">
  <header class="chat-header">دردشة أبيض وأسود</header>

  <div id="recordingBox">جاري التسجيل… <span id="timer">00:00</span></div>

  <div class="chat-messages" id="chatMessages"></div>

  <div class="chat-input">
    <button class="btn" id="attachBtn">Attach</button>
    <input type="text" id="msgInput" placeholder="اكتب رسالة...">
    <button class="btn" id="micBtn">Mic</button>
  </div>

  <div class="attach-bar" id="attachBar">
    <button id="fileBtn">File</button>
    <button id="cameraBtn">Camera</button>
    <button id="imageBtn">Image</button>
    <button id="pollBtn">Poll</button>
    <button id="locationBtn">Location</button>
  </div>

  <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display:none;">
  <input type="file" id="imageInput" accept="image/*" style="display:none;">
  <input type="file" id="fileInput" style="display:none;">
</div>

<script>
const chat = document.getElementById("chatMessages");
const attachBtn = document.getElementById("attachBtn");
const attachBar = document.getElementById("attachBar");
const cameraInput = document.getElementById("cameraInput");
const imageInput = document.getElementById("imageInput");
const fileInput = document.getElementById("fileInput");
const micBtn = document.getElementById("micBtn");
const msgInput = document.getElementById("msgInput");
const recordingBox = document.getElementById("recordingBox");
const timerDisplay = document.getElementById("timer");

let recorder=null, stream=null, chunks=[], seconds=0, timerInterval=null, isRecording=false;

/* شريط المرفقات مع انزلاق سلس */
attachBtn.addEventListener("click", ()=>{ attachBar.classList.toggle("show"); });

cameraInput.addEventListener("change", function(){ const file=this.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>addMessage(reader.result,"img"); reader.readAsDataURL(file); });
imageInput.addEventListener("change", function(){ const file=this.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>addMessage(reader.result,"img"); reader.readAsDataURL(file); });
fileInput.addEventListener("change", function(){ const file=this.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>addMessage(reader.result,"text"); reader.readAsDataURL(file); });

document.getElementById("cameraBtn").addEventListener("click",()=>cameraInput.click());
document.getElementById("imageBtn").addEventListener("click",()=>imageInput.click());
document.getElementById("fileBtn").addEventListener("click",()=>fileInput.click());

document.getElementById("pollBtn").addEventListener("click", ()=>{
  const question = prompt("اكتب سؤال الاستطلاع:");
  if(!question) return;
  const option1 = prompt("الخيار الأول:");
  const option2 = prompt("الخيار الثاني:");
  if(option1 && option2){ addMessage(`Poll: ${question}\n1: ${option1}\n2: ${option2}`,"text"); }
});

document.getElementById("locationBtn").addEventListener("click", ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude; const lon = pos.coords.longitude;
      addMessage(`Location: https://www.google.com/maps?q=${lat},${lon}`,"text");
    }, ()=>alert("تعذر الحصول على الموقع."));
  } else alert("الموقع غير مدعوم.");
});

function addMessage(content,type="text"){
  const div=document.createElement("div"); div.className="message";

  if(type==="img") div.innerHTML=`<img class="chat-img" src="${content}"><div class="status">Read</div>`;
  else div.innerHTML=`<span class="msg-text">${content}</span><div class="status">Read</div>`;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  // Toolbar عند الضغط على الرسالة
  div.addEventListener("click", (e)=>{
    const existingToolbar = document.querySelector(".msg-toolbar");
    if(existingToolbar) existingToolbar.remove();

    const toolbar = document.createElement("div");
    toolbar.className = "msg-toolbar";

    toolbar.style.top = (div.getBoundingClientRect().top + window.scrollY - 40) + "px";
    toolbar.style.left = (div.getBoundingClientRect().left) + "px";

    const copyBtn = document.createElement("button"); copyBtn.textContent="Copy";
    const editBtn = document.createElement("button"); editBtn.textContent="Edit";
    const deleteBtn = document.createElement("button"); deleteBtn.textContent="Delete";

    toolbar.appendChild(copyBtn);
    toolbar.appendChild(editBtn);
    toolbar.appendChild(deleteBtn);
    document.body.appendChild(toolbar);

    copyBtn.addEventListener("click", ()=>{
      const text = div.querySelector(".msg-text").textContent;
      navigator.clipboard.writeText(text);
      toolbar.remove();
    });
    editBtn.addEventListener("click", ()=>{
      const textSpan = div.querySelector(".msg-text");
      const newText = prompt("Edit message:", textSpan.textContent);
      if(newText!==null) textSpan.textContent = newText;
      toolbar.remove();
    });
    deleteBtn.addEventListener("click", ()=>{
      div.remove();
      toolbar.remove();
    });

    document.addEventListener("click", function hideToolbar(ev){
      if(!div.contains(ev.target) && !toolbar.contains(ev.target)){
        toolbar.remove();
        document.removeEventListener("click", hideToolbar);
      }
    });
  });
}

/* تسجيل صوت */
function updateTimer(){ seconds++; const m=String(Math.floor(seconds/60)).padStart(2,"0"); const s=String(seconds%60).padStart(2,"0"); timerDisplay.textContent=`${m}:${s}`; }
async function startRecording(){ if(isRecording) return; isRecording=true;
try{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(stream); chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    if(chunks.length>0){ const blob=new Blob(chunks,{type:"audio/mp3"}); const url=URL.createObjectURL(blob); addMessage(url,"text"); }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    recorder=null; chunks=[]; recordingBox.style.display="none";
    clearInterval(timerInterval); timerInterval=null; seconds=0; timerDisplay.textContent="00:00"; isRecording=false;
  };
  recorder.start(); seconds=0; timerDisplay.textContent="00:00"; recordingBox.style.display="block";
  timerInterval=setInterval(updateTimer,1000);
}catch(e){ alert("تعذر الوصول للميكروفون."); console.error(e); isRecording=false; }
}
function stopRecording(){ if(!isRecording) return; isRecording=false; if(recorder && recorder.state==="recording") recorder.stop(); recordingBox.style.display="none"; clearInterval(timerInterval); timerInterval=null; seconds=0; timerDisplay.textContent="00:00"; }

/* زر Mic يتحول لإرسال عند الكتابة */
msgInput.addEventListener("input", ()=>{
  if(msgInput.value.trim().length > 0) micBtn.textContent = "Send";
  else micBtn.textContent = "Mic";
});

micBtn.addEventListener("click", ()=>{
  if(msgInput.value.trim().length > 0){
    addMessage(msgInput.value,"text");
    msgInput.value="";
    micBtn.textContent = "Mic";
  } else {
    if(!isRecording) startRecording();
    else stopRecording();
  }
});
</script>

</body>
</html>
