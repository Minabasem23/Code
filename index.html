<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø±Ø¯Ø´Ø© ØµÙˆØªÙŠØ©</title>
<style>
body {margin:0; background:#121212; font-family:'Tajawal',sans-serif; color:white; display:flex; justify-content:center; align-items:center; height:100vh;}
.chat-container {width:95%; max-width:450px; height:92vh; background:#1e1e1e; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; position:relative;}
header.chat-header {text-align:center; padding:15px; background:#2c2c2c; font-weight:bold; border-bottom:1px solid #333;}
.chat-messages {flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:14px;}
.message {background:#0078ff; padding:10px 14px; max-width:75%; border-radius:12px; align-self:flex-end; word-wrap:break-word; border-bottom-right-radius:4px; position:relative;}
.status {margin-top:4px; font-size:11px; opacity:.7; text-align:right;}
img.chat-img {max-width:100%; border-radius:12px; margin-top:5px;}
.voice-btn {background:#005bbb; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:5px;}
.chat-input {padding:10px; background:#2c2c2c; display:flex; align-items:center; gap:8px;}
.chat-input input {flex:1; background:#3c3c3c; padding:12px; border:none; color:white; border-radius:10px;}
.btn {width:45px; height:45px; background:#0078ff; border-radius:50%; border:none; font-size:20px; color:white;}
#recordingBox {display:none; background:#b00020; padding:12px; text-align:center; font-weight:bold; position:absolute; bottom:60px; left:0; width:100%; animation:blink 1s infinite;}
@keyframes blink {0%{opacity:1;} 50%{opacity:0.5;} 100%{opacity:1;}}
</style>
</head>
<body>

<div class="chat-container">
  <header class="chat-header">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</header>
  <div id="recordingBox">ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ <span id="timer">00:00</span></div>
  <div class="chat-messages" id="chatMessages"></div>

  <div class="chat-input">
    <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button class="btn" type="button" id="micBtn">ğŸ¤</button>
  </div>
</div>

<script>
const chat = document.getElementById("chatMessages");
const micBtn = document.getElementById("micBtn");
const recordingBox = document.getElementById("recordingBox");
const timerDisplay = document.getElementById("timer");

let recorder = null;
let stream = null;
let chunks = [];
let seconds = 0;
let timerInterval = null;

function updateTimer() {
  seconds++;
  const m = String(Math.floor(seconds/60)).padStart(2,"0");
  const s = String(seconds%60).padStart(2,"0");
  timerDisplay.textContent = `${m}:${s}`;
}

async function startRecord() {
  if(recorder) return;
  try {
    if(stream){ stream.getTracks().forEach(track => track.stop()); stream=null; }
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    recorder = new MediaRecorder(stream);
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = () => {
      if(chunks.length>0){
        const blob = new Blob(chunks, { type:"audio/mp3" });
        const url = URL.createObjectURL(blob);
        addAudioMessage(url);
      }
      if(stream){ stream.getTracks().forEach(track=>track.stop()); stream=null; }
      recorder = null;
      chunks = [];
      recordingBox.style.display="none";
      clearInterval(timerInterval);
      timerInterval=null;
    };

    recorder.start();
    seconds=0;
    timerDisplay.textContent="00:00";
    recordingBox.style.display="block";
    timerInterval = setInterval(updateTimer,1000);

  } catch(e){
    alert("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù…Ø§Ø­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ØµÙˆØª.");
    console.error(e);
  }
}

function stopRecord(){ if(recorder && recorder.state==="recording") recorder.stop(); }

/* Ø­Ø¯Ø« Ù„Ù…Ø³ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ù†Ù‚Ø±Ø© Ø§Ù„Ù…Ø§ÙˆØ³ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª */
micBtn.addEventListener("touchstart", startRecord);
micBtn.addEventListener("touchend", stopRecord);
micBtn.addEventListener("mousedown", startRecord);
micBtn.addEventListener("mouseup", stopRecord);

/* Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ø¹ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ */
function addAudioMessage(url){
  const div = document.createElement("div");
  div.className = "message";

  const btn = document.createElement("button");
  btn.className = "voice-btn";
  btn.textContent = "â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª";

  const audioEl = new Audio(url);

  btn.addEventListener("click", () => {
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø£ØµÙˆØ§Øª Ø£Ø®Ø±Ù‰
    document.querySelectorAll(".voice-btn").forEach(b => {
      if(b!==btn && b.audioEl){b.audioEl.pause(); b.textContent="â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª";}
    });

    if(audioEl.paused){ audioEl.play().catch(e=>console.log(e)); btn.textContent="â¸ Ø¥ÙŠÙ‚Ø§Ù"; }
    else { audioEl.pause(); btn.textContent="â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"; }
  });

  btn.audioEl = audioEl;
  div.appendChild(btn);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
</script>

</body>
</html>
