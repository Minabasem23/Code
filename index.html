<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat ‚Äî Minimal Modern</title>
<style>
  :root{
    --bg:#0b0b0b;
    --card:#0f0f10;
    --accent:#ffffff;
    --muted:rgba(255,255,255,0.65);
    --border: rgba(255,255,255,0.08);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--accent);
    font-family:Inter, "Tajawal", system-ui, Arial;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* Wrapper */
  .app{
    width:100%;
    max-width:460px;
    height:95vh;
    background:linear-gradient(180deg,var(--card), #080808);
    border-radius:16px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    border:1px solid var(--border);
    box-shadow: 0 6px 30px rgba(0,0,0,0.6);
  }

  header.app-header{
    padding:14px;
    display:flex;
    align-items:center;
    gap:12px;
    border-bottom:1px solid var(--border);
  }
  .title{
    font-weight:600;
    letter-spacing:0.2px;
  }
  .subtitle{
    font-size:12px;
    color:var(--muted);
  }

  /* chat area */
  .messages{
    flex:1;
    padding:12px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
    background:
      linear-gradient(0deg, rgba(255,255,255,0.01), transparent 40%);
  }

  .msg{
    max-width:78%;
    align-self:flex-end;
    background:transparent;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    position:relative;
  }
  .msg .msg-content{ color:var(--accent); font-size:15px; white-space:pre-wrap; word-break:break-word; }
  .msg .meta{ font-size:11px; color:var(--muted); text-align:right; }
  .msg img{ max-width:100%; border-radius:8px; display:block; }

  /* audio player minimal (use browser controls but small) */
  .msg audio{
    width:170px;
    height:auto;
    outline:none;
    background:transparent;
  }

  /* input area */
  .composer{
    padding:12px;
    border-top:1px solid var(--border);
    display:flex;
    gap:8px;
    align-items:center;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  }
  .attach-btn, .action-btn{
    width:52px; height:44px;
    border-radius:10px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--accent);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
  }
  .text-input{
    flex:1;
    background:transparent;
    border:1px solid var(--border);
    padding:10px 12px;
    border-radius:10px;
    color:var(--accent);
    font-size:15px;
    outline:none;
  }

  /* attach bar sliding from bottom */
  .attach-bar{
    position:absolute;
    left:0; right:0;
    bottom:-120px;
    margin:0 auto;
    width:100%;
    max-width:460px;
    display:flex;
    gap:10px;
    justify-content:center;
    padding:12px;
    transition:bottom .28s ease;
    pointer-events:auto;
  }
  .attach-bar.open{ bottom:84px; } /* seats above composer */
  .attach-item{
    min-width:84px;
    border-radius:10px;
    border:1px solid var(--border);
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:center;
    justify-content:center;
    background:transparent;
    color:var(--accent);
    font-size:13px;
  }

  /* toolbar popup for message */
  .toolbar{
    position:absolute;
    background:var(--accent);
    color:#000;
    padding:6px;
    border-radius:10px;
    display:flex;
    gap:6px;
    box-shadow:0 6px 18px rgba(0,0,0,0.4);
    z-index:1200;
  }
  .toolbar button{
    background:transparent;
    border:none;
    padding:6px 8px;
    cursor:pointer;
    font-weight:600;
  }

  /* small screens adjustments */
  @media (max-width:420px){
    .msg audio{ width:140px; }
    .attach-item{ min-width:68px; font-size:12px; padding:8px; }
  }

</style>
</head>
<body>

<div class="app" role="application" aria-label="chat-app">
  <header class="app-header">
    <div>
      <div class="title">Chat ‚Äî Minimal</div>
      <div class="subtitle">Ready ¬∑ Modern ¬∑ Single file</div>
    </div>
  </header>

  <main class="messages" id="messages"></main>

  <div class="composer">
    <button class="attach-btn" id="attachBtn" title="Attach">üìé</button>
    <input id="input" class="text-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." autocomplete="off" />
    <button id="actionBtn" class="action-btn" title="Record or Send">üé§</button>
  </div>

  <!-- sliding attach bar -->
  <div class="attach-bar" id="attachBar" aria-hidden="true">
    <div class="attach-item" id="attachFile">File</div>
    <div class="attach-item" id="attachCamera">Camera</div>
    <div class="attach-item" id="attachImage">Image</div>
    <div class="attach-item" id="attachPoll">Poll</div>
    <div class="attach-item" id="attachLocation">Location</div>
  </div>

  <!-- hidden inputs -->
  <input id="fileInput" type="file" style="display:none" />
  <input id="imageInput" type="file" accept="image/*" style="display:none" />
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <div id="recordingBox" style="display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:100px; background:#fff; color:#000; padding:8px 12px; border-radius:8px;">Recording‚Ä¶ <span id="timer">00:00</span></div>
</div>

<script>
/* Minimal Modern single-file chat */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const actionBtn = document.getElementById('actionBtn');
const attachBtn = document.getElementById('attachBtn');
const attachBar = document.getElementById('attachBar');
const fileInput = document.getElementById('fileInput');
const imageInput = document.getElementById('imageInput');
const cameraInput = document.getElementById('cameraInput');
const attachFile = document.getElementById('attachFile');
const attachImage = document.getElementById('attachImage');
const attachCamera = document.getElementById('attachCamera');
const attachPoll = document.getElementById('attachPoll');
const attachLocation = document.getElementById('attachLocation');
const recordingBox = document.getElementById('recordingBox');
const timerDisplay = document.getElementById('timer');

let isRecording = false;
let recorder = null;
let stream = null;
let chunks = [];
let seconds = 0, timerInterval = null;

/* Utilities */
function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

/* addMessage: wraps content inside span.msg-content for all types */
function addMessage(content, type = 'text'){
  const msg = document.createElement('div');
  msg.className = 'msg';

  const container = document.createElement('span');
  container.className = 'msg-content';

  if(type === 'text'){
    container.textContent = content;
  } else if(type === 'img'){
    const img = document.createElement('img');
    img.src = content;
    container.appendChild(img);
  } else if(type === 'audio'){
    const audio = document.createElement('audio');
    audio.controls = true;
    audio.src = content;
    audio.preload = 'metadata';
    audio.addEventListener('ended', ()=> {
      // reset UI when ended (do not autoplay)
      // if custom buttons were used, set them to "play" here
      // ensure playbackRate not changed
      // no auto replay
      audio.currentTime = 0;
    });
    container.appendChild(audio);
  } else { // fallback - show as text
    container.textContent = String(content);
  }

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = '‚úì‚úì Read';

  msg.appendChild(container);
  msg.appendChild(meta);
  messagesEl.appendChild(msg);
  scrollToBottom();

  attachMsgToolbar(msg);
}

/* Toolbar (Copy / Edit / Delete) - works for every message type
   Copy: uses temporary textarea (works on mobile & desktop)
   Edit: only for text messages (msg-content with no child elements)
*/
function attachMsgToolbar(msg){
  msg.addEventListener('click', (ev)=>{
    ev.stopPropagation(); // avoid body click
    // remove existing toolbar
    const old = document.querySelector('.toolbar');
    if(old) old.remove();

    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';

    const btnCopy = document.createElement('button'); btnCopy.textContent = 'Copy';
    const btnEdit = document.createElement('button'); btnEdit.textContent = 'Edit';
    const btnDel  = document.createElement('button'); btnDel.textContent = 'Delete';

    toolbar.appendChild(btnCopy);
    toolbar.appendChild(btnEdit);
    toolbar.appendChild(btnDel);
    document.body.appendChild(toolbar);

    // place toolbar above message if possible
    const r = msg.getBoundingClientRect();
    let top = window.scrollY + r.top - toolbar.offsetHeight - 8;
    if(top < 8) top = window.scrollY + r.bottom + 8; // if not enough space, place under
    toolbar.style.top = top + 'px';
    toolbar.style.left = Math.max(8, r.left) + 'px';

    // COPY
    btnCopy.onclick = ()=> {
      const contentEl = msg.querySelector('.msg-content');
      let textToCopy = '';
      // for different types, decide what to copy
      const audio = contentEl.querySelector('audio');
      const img = contentEl.querySelector('img');
      if(audio) textToCopy = audio.src || '';
      else if(img) textToCopy = img.src || '';
      else textToCopy = contentEl.innerText || contentEl.textContent || '';
      // fallback: use textarea method
      const ta = document.createElement('textarea');
      ta.value = textToCopy;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); alert('Copied'); }
      catch(e){ alert('Copy failed'); }
      ta.remove();
      toolbar.remove();
    };

    // EDIT (only for plain text messages)
    btnEdit.onclick = ()=> {
      const contentEl = msg.querySelector('.msg-content');
      // allow edit only if contentEl has no child elements (pure text)
      if(contentEl.children.length === 0){
        const oldText = contentEl.textContent;
        const n = prompt('Edit message:', oldText);
        if(n !== null){
          contentEl.textContent = n;
        }
      } else {
        alert('Editing supported for text messages only.');
      }
      toolbar.remove();
    };

    // DELETE
    btnDel.onclick = ()=> {
      msg.remove();
      toolbar.remove();
    };

    // hide toolbar clicking outside
    function hideListener(e){
      if(!toolbar.contains(e.target) && !msg.contains(e.target)){
        toolbar.remove();
        document.removeEventListener('click', hideListener);
      }
    }
    document.addEventListener('click', hideListener);
  });
}

/* Attach bar toggle */
attachBtn.addEventListener('click', ()=> {
  attachBar.classList.toggle('open');
  attachBar.setAttribute('aria-hidden', String(!attachBar.classList.contains('open')));
});

/* Attach actions */
attachFile.addEventListener('click', ()=> fileInput.click());
attachImage.addEventListener('click', ()=> imageInput.click());
attachCamera.addEventListener('click', ()=> cameraInput.click());

fileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  // read text/file as dataURL if image else show filename
  if(f.type.startsWith('image/')) {
    const fr = new FileReader();
    fr.onload = ()=> addMessage(fr.result, 'img');
    fr.readAsDataURL(f);
  } else {
    addMessage(`${f.name} (file)`, 'text');
  }
  fileInput.value = '';
});

imageInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> addMessage(fr.result, 'img');
  fr.readAsDataURL(f);
  imageInput.value = '';
});

cameraInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> addMessage(fr.result, 'img');
  fr.readAsDataURL(f);
  cameraInput.value = '';
});

attachPoll.addEventListener('click', ()=>{
  const q = prompt('Poll question:');
  if(!q) return;
  const a1 = prompt('Option 1:'); if(!a1) return;
  const a2 = prompt('Option 2:'); if(!a2) return;
  addMessage(`Poll: ${q}\n1) ${a1}\n2) ${a2}`, 'text');
});

attachLocation.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    addMessage(`Location: https://www.google.com/maps?q=${lat},${lon}`, 'text');
  }, ()=> alert('Unable to get location'));
});

/* Recording logic: single button toggles record / stop
   Using click (not touchstart) to avoid duplicate events on mobile.
*/
function updateTimer(){
  seconds++;
  const mm = String(Math.floor(seconds/60)).padStart(2,'0');
  const ss = String(seconds % 60).padStart(2,'0');
  timerDisplay.textContent = `${mm}:${ss}`;
}

async function startRecord(){
  if(isRecording) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = ()=>{
      if(chunks.length){
        const blob = new Blob(chunks, { type: 'audio/webm' }); // webm widely supported; browser will play it
        const url = URL.createObjectURL(blob);
        addMessage(url, 'audio'); // << send as audio
      }
      // stop tracks & cleanup
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      recorder = null;
      chunks = [];
      isRecording = false;
      clearInterval(timerInterval);
      timerInterval = null;
      seconds = 0;
      recordingBox.style.display = 'none';
    };
    recorder.start();
    isRecording = true;
    seconds = 0;
    timerDisplay.textContent = '00:00';
    recordingBox.style.display = 'block';
    timerInterval = setInterval(updateTimer, 1000);
  }catch(err){
    alert('Microphone access denied or not available.');
    isRecording = false;
  }
}

function stopRecord(){
  if(!isRecording) return;
  if(recorder && recorder.state === 'recording') recorder.stop();
}

/* Action button behavior: if there's text -> send; else toggle record */
inputEl = inputEl || inputEl; // noop
inputEl = inputEl = null; // silence linter (not used)

inputEl = inputEl; // keep

inputEl = null; // keep

// hook input element for changing icon text
inputEl = document.getElementById('input');
inputEl.addEventListener('input', ()=>{
  const has = inputEl.value.trim().length > 0;
  actionBtn.textContent = has ? '‚û°' : 'üé§';
});

// main action
actionBtn.addEventListener('click', ()=>{
  const has = inputEl.value.trim().length > 0;
  if(has){
    addMessage(inputEl.value.trim(), 'text');
    inputEl.value = '';
    actionBtn.textContent = 'üé§';
  } else {
    if(!isRecording) startRecord();
    else stopRecord();
  }
});

/* initial demo messages (optional) */
// addMessage('ŸÖÿ±ÿ≠ÿ®ÿß! Ÿáÿ∞Ÿá Ÿàÿßÿ¨Ÿáÿ© ŸÖŸèÿ®ÿ≥ÿ∑ÿ© Ÿàÿπÿµÿ±Ÿäÿ©', 'text');

</script>
</body>
</html>
